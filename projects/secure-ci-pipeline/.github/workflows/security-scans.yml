name: Security Pipeline

on: push
    # pull_request:
    #     branches: [ main ]

jobs:
    static-analysis:
        name: Static Code Analysis
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v2           
            - name: Initialize CodeQL
              uses: github/codeql-action/init@v2
              with:
                languages: python         
            - name: Perform CodeQL Analysis
              uses: github/codeql-action/analyze@v2
    
    trivy_dependency-scan:
      name: Scan Dependencies with Trivy
      runs-on: ubuntu-latest
      steps:
        - name: Checkout Code
          uses: actions/checkout@v2
        - name: Install Trivy
          run: |
            sudo apt-get update -y
            sudo apt-get install -y wget
            wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_linux_amd64.tar.gz
            tar -xvf trivy_linux_amd64.tar.gz
            sudo mv trivy /usr/local/bin/
        - name: Run Trivy on Dependencies
          run: |
            trivy fs --severity HIGH,CRITICAL --exit-code 1 --no-progress --format table app/
    
    container-security:
        name: Docker Image Security Scan
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v2
          - name: Build docker image
            run: docker build -t security-test-app:latest .
          - name: Run Trivy Scan
            run: docker run --rm -v $PWD:/app aquasec/trivy image --exit-code 1 security-test-app:latest
    
    terraform-security:
      name: Terraform Security Scan
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v2
        - name: Install Checkov
          run: pip install checkov
        - name: Run Checkov on Terraform Code
          run: checkov -d terraform/ --quiet --soft-fail